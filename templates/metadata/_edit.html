{% extends "sproutseo/_layouts/base" %}
{% import "_includes/forms" as forms %}

{% set title %}
	{% if not metadataGroupId is empty %}
		{{ metaTags.name }}
	{% else %}
		{{ "New Metadata Section"|t }}
	{% endif %}
{% endset %}

{% set crumbs = [
	{ label: "Metadata"|t, url: url('sproutseo/metadata') }
] %}

{% set centered = true %}

{% set fullPageForm = true %}

{% if craft.request.getSegment(3) == 'new' %}
	{% set saveShortcutRedirect = url('sproutseo/metadata') %}
{% else %}
	{% set saveShortcutRedirect = url('sproutseo/metadata/' ~ metadataGroupId) %}
{% endif %}

{# Set a field context so we can manage field visibility between the SEO Metadata Groups and the Field Types #}
{% set fieldContext = 'metaTagGroups' %}

{# Map the `metaTags` object to `values` so we can use the same templates for SEO Metadata Groups and the Field Types #}

{% set values = metaTags %}

{% block saveButton %}
	<div class="buttons">
		<input class="btn submit" type="submit" value="Save">
	</div>
{% endblock %}

{% block main %}

	<div class="grid first" data-max-cols="3">
		<div class="item" data-position="left" data-min-colspan="2" data-max-colspan="3">
			<div id="fields" class="pane">

				<input type="hidden" name="action" value="sproutSeo/metadata/saveMetadataGroup">
				<input type="hidden" name="redirect" value="sproutseo/metadata">
				<input type="hidden" name="sproutseo[metadata][id]" value="{{ metadataGroupId }}">
				<input type="hidden" name="sproutseo[metadata][isSitemapCustomPage]" value="{{ isSitemapCustomPage }}">
				<input type="hidden" name="sproutseo[metadata][type]" value="{{ metaTags.type }}">
				<input type="hidden" name="sproutseo[metadata][elementGroupId]" value="{{ metaTags.elementGroupId }}">

				{% include 'sproutseo/_fieldtypes/optimize/input' %}

			</div>
		</div>
		<div class="item" data-position="right" data-colspan="1">
			<div class="pane meta">

				{{ forms.textField({
					label: "Name <span class='info'>Human readable Metadata Group name</span>"|t,
					id: "name",
					name: 'sproutseo[metadata][name]',
					value: metaTags.name,
					errors: metaTags.getErrors('name'),
					readonly: not isNew,
					class: not isNew ? 'disabled' : ''
				}) }}

				{{ forms.textField({
					label: "Handle <span class='info'>Name you will use to refer to this meta-tag group in your templates</span>"|t,
					id: "handle",
					name: 'sproutseo[metadata][handle]',
					value: metaTags.handle,
					errors: metaTags.getErrors('handle'),
					readonly: not isNew,
					class: not isNew ? 'disabled' : ''
				}) }}

				{{ forms.textField({
					label: "URL"|t,
					id: "url",
					name: 'sproutseo[metadata][sitemapUrl]',
					value: (metaTags.sitemapUrl == '__home__') ? "/" : metaTags.sitemapUrl,
					errors: metaTags.getErrors('sitemapUrl'),
					readonly: not isNew,
					class: not isNew ? 'disabled' : ''
				}) }}

				<div class="field">
					<div class="heading">
						<label>{{ "Section"|t }}</label>
					</div>
					<div class="input">
						<h6>{{ elementInfo is not empty ? elementInfo['name'] : "Custom Page"|t }}</h6>
					</div>
				</div>

				<div class="field">
					<div class="heading">
						<label>{{ "Element"|t }} <span class="info">{% if elementInfo is not empty %}{{ "The Matched Element variable <code>{matchedElement}</code> is available to your URL-enabled pages"|t({ 'matchedElement' : elementInfo['matchedElementVariable'] })|raw }}{% else %}{{ "Custom Pages do not have any pre-prepared Elements available to the page"|t }}{% endif %}</span></label>
					</div>
					<div class="input">
						<h6>{{ elementInfo is not empty ? elementInfo['matchedElementVariable'] : "–" }}</h6>
					</div>
				</div>

				{% set statusInput %}

					<div class="left">
						{{ forms.lightswitch({
							id: 'enabled',
							name: 'sproutseo[metadata][enabled]',
							on:  (metaTags.enabled is defined ? metaTags.enabled : false)
						}) }}
					</div>

					<div class="right">
						<input type="button" class="btn small formsubmit" value="Delete" data-action="sproutForms/entries/deleteEntry" data-confirm="Are you sure you want to delete this entry and all of it's data?" data-redirect="sproutforms/entries">
					</div>

				{% endset %}

				{{ forms.field({
					label: "Enabled"|t,
					id: 'enabled'
				}, statusInput) }}

			</div>

			<div class="pane meta">
				{% set priorityList = {
				'1.0': '1.0 ↑ Highest'|t,
				'0.9': '0.9',
				'0.8': '0.8',
				'0.7': '0.7',
				'0.6': '0.6',
				'0.5': '0.5',
				'0.4': '0.4',
				'0.3': '0.3',
				'0.2': '0.2',
				'0.1': '0.1',
				'0.0': '0.0 ↓ Lowest'|t
				} %}

				{% set frequencyList = {
				'always': 'Always'|t,
				'hourly': 'Hourly'|t,
				'daily': 'Daily'|t,
				'weekly': 'Weekly'|t,
				'monthly': 'Monthly'|t,
				'yearly': 'Yearly'|t,
				'never': 'Never'|t
				} %}

				{{ forms.selectField({
					label: "Priority"|t,
					name: 'sproutseo[metadata][sitemapPriority]',
					options: priorityList,
					value: (metaTags.sitemapPriority ? metaTags.sitemapPriority : 0.5),
					errors: "",
					required: false
				}) }}

				{{ forms.selectField({
					label: "Change Frequency"|t,
					name: 'sproutseo[metadata][sitemapChangeFrequency]',
					options: frequencyList,
					value: (metaTags.sitemapChangeFrequency ? metaTags.sitemapChangeFrequency : 'weekly'),
					errors: "",
					required: false
				}) }}

			</div>

			<div class="pane meta">
				{% if settings.displayPreview %}
					<ul class="sproutseo-preview-btns">
					<li class="selected">Search</li>
					<li>Facebook</li>
					<li>Twitter</li>
					</ul>

					{% include 'sproutseo/_fieldtypes/optimize/previews/search' %}

					{#{% include 'sproutseo/_fieldtypes/optimize/previews/opengraph' %}#}

					{#{% include 'sproutseo/_fieldtypes/optimize/previews/twittercard' %}#}

				{% endif %}
			</div>

		</div>
	</div>

{% endblock %}

{% if metaTags.name is not defined or not metaTags.handle %}
	{% includeJs "new Craft.HandleGenerator('#name', '#handle');" %}
{% endif %}

{% includeJsResource "sproutseo/js/MetaTags.js" %}

{% set js %}

	$('#sproutseo-optimizedkeywords-field input').tagEditor({
		animateDelete: 20
	});

	new Craft.SproutSeoMetaTags();

{% endset %}

{% includeJs js %}

